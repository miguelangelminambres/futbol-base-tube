<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futbol Base TUBE - La Mayor Biblioteca de Ejercicios de F√∫tbol del Mundo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d9f4f;
            --primary-dark: #0a7a3d;
            --primary-light: #10b85c;
            --accent: #f5c518;
            --dark: #0f0f1a;
            --dark-card: #16162a;
            --dark-border: #2a2a4a;
            --text: #ffffff;
            --text-muted: #8b8ba7;
            --danger: #ef4444;
            --gradient-primary: linear-gradient(135deg, #0d9f4f 0%, #0a7a3d 100%);
            --gradient-hero: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0d2818 100%);
            --shadow-glow: 0 0 30px rgba(13, 159, 79, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--dark); color: var(--text); }
        
        /* Header */
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(15, 15, 26, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--dark-border); }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; cursor: pointer; }
        .logo-icon { width: 48px; height: 48px; background: var(--gradient-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: var(--shadow-glow); }
        .logo-text { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--text); display: flex; align-items: center; gap: 6px; }
        .logo-tube { background: #ff0000; color: white; padding: 2px 8px; border-radius: 4px; font-size: 18px; font-family: 'Arial', sans-serif; font-weight: 900; font-style: italic; letter-spacing: -0.5px; }
        .nav { display: flex; align-items: center; gap: 8px; }
        .nav-link { padding: 10px 20px; color: var(--text-muted); text-decoration: none; font-weight: 500; border-radius: 8px; transition: all 0.3s; cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: var(--text); background: rgba(255,255,255,0.05); }
        .nav-link.active { color: var(--primary); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-ghost { background: transparent; color: var(--text); border: 2px solid var(--dark-border); }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 4px 15px rgba(13, 159, 79, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13, 159, 79, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }

        /* User Menu */
        .user-menu { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: var(--dark-card); border-radius: 50px; cursor: pointer; border: 1px solid var(--dark-border); position: relative; }
        .user-avatar { width: 36px; height: 36px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .user-name { font-weight: 500; font-size: 14px; }
        .user-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; padding: 8px; min-width: 200px; display: none; z-index: 100; }
        .user-dropdown.show { display: block; }
        .user-dropdown-header { padding: 12px 16px; border-bottom: 1px solid var(--dark-border); margin-bottom: 8px; }
        .user-dropdown-level { font-size: 14px; font-weight: 600; color: var(--primary); }
        .user-dropdown-xp { font-size: 12px; color: var(--text-muted); }
        .user-dropdown-item { padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .user-dropdown-item:hover { background: rgba(255,255,255,0.05); }
        .user-dropdown-item.danger { color: var(--danger); }
        .user-dropdown-item.upgrade { color: var(--accent); font-weight: 600; }

        /* Plan Badges */
        .plan-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .plan-badge.pro { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .plan-badge.coach { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }

        /* Header Stats */
        .user-stats-header { display: flex; align-items: center; gap: 12px; margin-right: 8px; }
        .xp-badge { background: rgba(245, 197, 24, 0.15); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .racha-badge { background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .limit-badge { background: rgba(139, 139, 167, 0.15); color: var(--text-muted); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: none; }
        .limit-badge.limit-reached { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Hero */
        .hero { min-height: 90vh; background: var(--gradient-hero); display: flex; align-items: center; justify-content: center; text-align: center; padding: 140px 24px 80px; position: relative; overflow: hidden; }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230d9f4f' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; }
        .hero-content { max-width: 900px; position: relative; z-index: 1; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 24px; background: rgba(13, 159, 79, 0.15); border: 1px solid rgba(13, 159, 79, 0.3); border-radius: 50px; font-size: 14px; color: var(--primary-light); margin-bottom: 32px; font-weight: 600; }
        .hero-title-main { font-family: 'Bebas Neue', sans-serif; font-size: clamp(42px, 7vw, 68px); line-height: 1.1; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px; }
        .tube-logo { display: inline-flex; align-items: center; background: #ff0000; padding: 4px 16px; border-radius: 8px; margin-left: 8px; }
        .tube-text { font-family: 'Roboto', 'Arial', sans-serif; font-weight: 900; font-style: italic; color: white; letter-spacing: -1px; }
        .hero-tagline { font-family: 'Bebas Neue', sans-serif; font-size: clamp(18px, 3vw, 26px); color: var(--accent); letter-spacing: 2px; margin-bottom: 20px; }
        .hero-desc { font-size: 18px; color: var(--text-muted); margin-bottom: 32px; max-width: 650px; margin-left: auto; margin-right: auto; line-height: 1.7; }
        .hero-desc strong { color: var(--text); }
        .hero-features { display: flex; justify-content: center; gap: 32px; margin-bottom: 40px; flex-wrap: wrap; }
        .hero-feature { display: flex; align-items: center; gap: 8px; font-size: 15px; color: var(--text); }
        .hero-feature-icon { font-size: 20px; }
        .hero-buttons { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 48px; }
        .btn-lg { padding: 16px 32px; font-size: 16px; }
        .hero-stats { display: flex; justify-content: center; gap: 48px; padding-top: 40px; border-top: 1px solid var(--dark-border); flex-wrap: wrap; }
        .hero-stat { text-align: center; }
        .hero-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 42px; color: var(--primary); }
        .hero-stat-label { font-size: 14px; color: var(--text-muted); }
        .hero-cta-text { margin-top: 32px; font-size: 15px; color: var(--text-muted); }
        .hero-cta-text a { color: var(--primary); text-decoration: none; font-weight: 600; }

        /* Biblioteca */
        .biblioteca { max-width: 1400px; margin: 0 auto; padding: 40px 24px; display: grid; grid-template-columns: 280px 1fr; gap: 32px; }
        
        /* Sidebar */
        .filters-sidebar { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 20px; padding: 24px; height: fit-content; position: sticky; top: 105px; max-height: calc(100vh - 130px); overflow-y: auto; }
        .filters-sidebar::-webkit-scrollbar { width: 6px; }
        .filters-sidebar::-webkit-scrollbar-track { background: transparent; }
        .filters-sidebar::-webkit-scrollbar-thumb { background: var(--dark-border); border-radius: 3px; }
        .filters-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--dark-border); }
        .filters-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .filters-badge { background: var(--primary); color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; display: none; }
        .filters-badge.show { display: inline-block; }
        .filters-clear { color: var(--primary); font-size: 13px; cursor: pointer; }
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: block; }
        .filter-select { width: 100%; padding: 12px 16px; background: var(--dark); border: 1px solid var(--dark-border); border-radius: 10px; color: var(--text); font-size: 14px; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        .difficulty-pills { display: flex; gap: 8px; }
        .difficulty-pill { flex: 1; padding: 10px; text-align: center; background: var(--dark); border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 600; color: var(--text-muted); }
        .difficulty-pill:hover { background: rgba(255,255,255,0.06); color: var(--text); }
        .difficulty-pill.active { border-color: var(--primary); background: rgba(13, 159, 79, 0.15); color: var(--primary); }

        /* Main */
        .biblioteca-main { display: flex; flex-direction: column; gap: 24px; }
        .biblioteca-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .biblioteca-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; }
        .biblioteca-count { color: var(--text-muted); font-size: 14px; }
        .biblioteca-search { display: flex; align-items: center; gap: 12px; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; padding: 12px 20px; width: 320px; }
        .biblioteca-search input { flex: 1; background: none; border: none; color: var(--text); font-size: 14px; outline: none; }
        .biblioteca-search input::placeholder { color: var(--text-muted); }

        /* Cards */
        .ejercicios-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .ejercicio-card { background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 20px; overflow: hidden; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
        .ejercicio-card:hover { transform: translateY(-8px); border-color: var(--primary); box-shadow: var(--shadow-glow); }
        .ejercicio-thumbnail { position: relative; aspect-ratio: 16/9; overflow: hidden; background: var(--dark); }
        .ejercicio-thumbnail img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
        .ejercicio-card:hover .ejercicio-thumbnail img { transform: scale(1.05); }
        .ejercicio-duration { position: absolute; bottom: 12px; right: 12px; background: rgba(0,0,0,0.85); padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .ejercicio-difficulty { position: absolute; top: 12px; left: 12px; background: var(--accent); color: var(--dark); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        .ejercicio-lang { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.85); padding: 4px 8px; border-radius: 6px; font-size: 14px; }
        .ejercicio-play { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 20px rgba(13, 159, 79, 0.5); }
        .ejercicio-play::after { content: ''; border-left: 16px solid white; border-top: 10px solid transparent; border-bottom: 10px solid transparent; margin-left: 4px; }
        .ejercicio-card:hover .ejercicio-play { transform: translate(-50%, -50%) scale(1); }
        .ejercicio-body { padding: 20px; }
        .ejercicio-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ejercicio-meta { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 13px; margin-bottom: 12px; }
        .ejercicio-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .ejercicio-tag { padding: 4px 12px; background: rgba(139, 92, 246, 0.15); color: #a78bfa; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .ejercicio-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 16px; border-top: 1px solid var(--dark-border); }
        .ejercicio-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text-muted); }
        .ejercicio-stat { display: flex; align-items: center; gap: 4px; }
        .ejercicio-actions { display: flex; gap: 8px; }
        .ejercicio-action { width: 36px; height: 36px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; }
        .ejercicio-action:hover { background: var(--primary); color: white; }
        .ejercicio-action.active { background: var(--danger); color: white; }
        .ejercicio-action.in-session { background: var(--primary); color: white; }

        /* States */
        .state-container { grid-column: 1 / -1; text-align: center; padding: 80px 40px; }
        .state-icon { font-size: 64px; margin-bottom: 16px; }
        .state-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .state-text { color: var(--text-muted); }
        .loading-spinner { width: 48px; height: 48px; border: 3px solid var(--dark-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 24px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--dark-card); border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 16px; right: 16px; width: 44px; height: 44px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; z-index: 10; }
        .modal-close:hover { background: rgba(255,255,255,0.2); }
        .modal-video { aspect-ratio: 16/9; background: black; }
        .modal-video iframe { width: 100%; height: 100%; border: none; }
        .modal-body { padding: 24px; }
        .modal-title { font-size: 24px; font-weight: 700; margin-bottom: 16px; }
        .modal-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
        .modal-tag { padding: 6px 16px; background: rgba(139, 92, 246, 0.15); color: #a78bfa; border-radius: 20px; font-size: 13px; }
        .modal-tag.dif { background: rgba(245, 197, 24, 0.15); color: var(--accent); }
        .modal-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .modal-info-item { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px; text-align: center; }
        .modal-info-icon { font-size: 24px; margin-bottom: 8px; }
        .modal-info-value { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
        .modal-info-label { font-size: 12px; color: var(--text-muted); }
        .modal-description { color: var(--text-muted); line-height: 1.7; margin-bottom: 24px; }
        .modal-footer { display: flex; gap: 12px; flex-wrap: wrap; }
        .modal-footer .btn { flex: 1; min-width: 150px; justify-content: center; }

        /* Auth Modal */
        .auth-modal { max-width: 420px; padding: 40px; }
        .auth-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; text-align: center; margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-muted); text-align: center; margin-bottom: 32px; }
        .auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; background: var(--dark); border: 2px solid transparent; border-radius: 10px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s; }
        .auth-tab.active { border-color: var(--primary); color: var(--primary); background: rgba(13, 159, 79, 0.1); }
        .auth-form { display: flex; flex-direction: column; gap: 16px; }
        .auth-input { width: 100%; padding: 14px 18px; background: var(--dark); border: 2px solid var(--dark-border); border-radius: 12px; color: var(--text); font-size: 14px; }
        .auth-input:focus { outline: none; border-color: var(--primary); }
        .auth-input::placeholder { color: var(--text-muted); }
        .auth-error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 12px 16px; border-radius: 10px; font-size: 13px; display: none; }
        .auth-error.show { display: block; }

        /* Session FAB and Drawer */
        .session-fab { position: fixed; bottom: 32px; right: 32px; z-index: 1500; display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: rgba(22, 22, 42, 0.85); backdrop-filter: blur(20px); border: 1px solid var(--dark-border); border-radius: 50px; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .session-fab:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 12px 40px rgba(13, 159, 79, 0.3); }
        .session-fab.has-items { border-color: var(--primary); }
        .session-fab-icon { width: 44px; height: 44px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .session-fab-content { display: flex; flex-direction: column; }
        .session-fab-title { font-weight: 600; font-size: 14px; }
        .session-fab-count { font-size: 12px; color: var(--text-muted); }
        .session-fab-badge { position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; border: 3px solid var(--dark); display: none; }
        .session-fab.has-items .session-fab-badge { display: flex; }
        
        .session-drawer { position: fixed; top: 0; right: -420px; width: 400px; max-width: 100%; height: 100vh; background: var(--dark-card); border-left: 1px solid var(--dark-border); z-index: 2500; display: flex; flex-direction: column; transition: right 0.4s cubic-bezier(0.22, 1, 0.36, 1); }
        .session-drawer.open { right: 0; }
        .session-drawer-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2400; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .session-drawer-backdrop.show { opacity: 1; visibility: visible; }
        .session-drawer-header { padding: 24px; border-bottom: 1px solid var(--dark-border); display: flex; align-items: center; justify-content: space-between; }
        .session-drawer-title { font-family: 'Bebas Neue', sans-serif; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .session-drawer-close { width: 40px; height: 40px; background: var(--dark); border: none; border-radius: 10px; color: var(--text-muted); cursor: pointer; font-size: 20px; }
        .session-drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
        .session-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .session-empty-icon { font-size: 48px; margin-bottom: 12px; }
        .session-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark); border: 1px solid var(--dark-border); border-radius: 12px; margin-bottom: 12px; cursor: grab; transition: all 0.2s; }
        .session-item:hover { border-color: var(--primary); }
        .session-item-thumb { width: 60px; height: 40px; border-radius: 6px; object-fit: cover; background: var(--dark-border); }
        .session-item-info { flex: 1; min-width: 0; }
        .session-item-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .session-item-meta { font-size: 11px; color: var(--text-muted); }
        .session-item-remove { width: 28px; height: 28px; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .session-item-remove:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .session-drawer-footer { padding: 20px; border-top: 1px solid var(--dark-border); background: var(--dark); }
        .session-stats { display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 14px; }
        .session-stats span { color: var(--text-muted); }
        .session-stats strong { color: var(--primary); }
        .session-actions { display: flex; gap: 12px; }
        .session-actions .btn { flex: 1; justify-content: center; }

        /* Save/View Session Modals */
        .save-modal { max-width: 450px; padding: 32px; }
        .save-modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 20px; }
        .save-modal .auth-input { margin-bottom: 16px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .sessions-list { max-height: 250px; overflow-y: auto; margin-bottom: 16px; }
        .session-list-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--dark); border: 2px solid var(--dark-border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .session-list-item:hover { border-color: var(--primary); }
        .session-list-item-info { flex: 1; }
        .session-list-item-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .session-list-item-meta { font-size: 12px; color: var(--text-muted); }
        .session-list-item-count { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .session-divider { text-align: center; color: var(--text-muted); font-size: 13px; margin: 20px 0; position: relative; }
        .session-divider::before, .session-divider::after { content: ''; position: absolute; top: 50%; width: 35%; height: 1px; background: var(--dark-border); }
        .session-divider::before { left: 0; }
        .session-divider::after { right: 0; }

        .view-session-modal { max-width: 600px; padding: 0; }
        .view-session-header { padding: 24px 24px 16px; border-bottom: 1px solid var(--dark-border); }
        .view-session-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 8px; }
        .view-session-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: var(--text-muted); }
        .view-session-objetivo { padding: 16px 24px; background: rgba(13, 159, 79, 0.1); border-left: 4px solid var(--primary); font-size: 14px; }
        .view-session-objetivo:empty { display: none; }
        .view-session-exercises { padding: 16px 24px; }
        .view-session-exercise { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark); border-radius: 12px; margin-bottom: 10px; }
        .view-session-exercise-num { width: 28px; height: 28px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
        .view-session-exercise-thumb { width: 80px; height: 50px; border-radius: 8px; object-fit: cover; background: var(--dark-border); flex-shrink: 0; }
        .view-session-exercise-info { flex: 1; min-width: 0; }
        .view-session-exercise-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .view-session-exercise-meta { font-size: 12px; color: var(--text-muted); }
        .view-session-footer { padding: 16px 24px; border-top: 1px solid var(--dark-border); display: flex; gap: 12px; flex-wrap: wrap; }
        .view-session-footer .btn { flex: 1; min-width: 100px; justify-content: center; }

        .my-sessions-modal { max-width: 550px; padding: 24px; max-height: 80vh; display: flex; flex-direction: column; }
        .my-sessions-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .my-session-card { background: var(--dark); border: 1px solid var(--dark-border); border-radius: 14px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .my-session-card:hover { border-color: var(--primary); transform: translateX(4px); }
        .my-session-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
        .my-session-card-name { font-weight: 700; font-size: 16px; }
        .my-session-card-date { font-size: 12px; color: var(--text-muted); background: var(--dark-card); padding: 4px 10px; border-radius: 6px; }
        .my-session-card-meta { display: flex; gap: 16px; font-size: 13px; color: var(--text-muted); }

        /* Notifications */
        .notif-bell { position: relative; cursor: pointer; padding: 8px; margin-right: 8px; }
        .notif-badge { position: absolute; top: 2px; right: 2px; min-width: 18px; height: 18px; background: var(--danger); border-radius: 50%; font-size: 11px; font-weight: 700; display: none; align-items: center; justify-content: center; }
        .notif-badge.show { display: flex; }
        .notif-dropdown { position: absolute; top: calc(100% + 8px); right: 0; width: 320px; max-height: 400px; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 16px; display: none; z-index: 1000; overflow: hidden; }
        .notif-dropdown.show { display: block; }
        .notif-header { padding: 16px; border-bottom: 1px solid var(--dark-border); display: flex; align-items: center; justify-content: space-between; }
        .notif-header-title { font-weight: 700; font-size: 15px; }
        .notif-header-action { font-size: 12px; color: var(--primary); cursor: pointer; }
        .notif-list { max-height: 320px; overflow-y: auto; }
        .notif-item { padding: 14px 16px; border-bottom: 1px solid var(--dark-border); cursor: pointer; transition: background 0.2s; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-item.unread { background: rgba(13, 159, 79, 0.05); border-left: 3px solid var(--primary); }
        .notif-item-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
        .notif-item-message { font-size: 12px; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .notif-item-time { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        .notif-empty { padding: 40px 20px; text-align: center; color: var(--text-muted); }

        /* Upload Modal - Clean Version */
        .upload-modal { max-width: 650px; padding: 0; max-height: 90vh; display: flex; flex-direction: column; }
        .upload-header { padding: 24px; border-bottom: 1px solid var(--dark-border); }
        .upload-header h2 { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 4px; }
        .upload-header p { color: var(--text-muted); font-size: 14px; }
        .upload-body { padding: 24px; overflow-y: auto; flex: 1; }
        .upload-section { margin-bottom: 28px; }
        .upload-section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .upload-section-title .upload-hint { font-weight: 400; color: var(--text-muted); font-size: 12px; }
        .upload-bonus { color: var(--accent); font-weight: 600; font-size: 12px; }

        /* Source Tabs */
        .upload-source-tabs { display: flex; gap: 12px; margin-bottom: 16px; }
        .upload-source-tab { flex: 1; padding: 14px; background: var(--dark); border: 2px solid var(--dark-border); border-radius: 12px; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .upload-source-tab:hover { border-color: var(--text-muted); }
        .upload-source-tab.active { border-color: var(--primary); background: rgba(13, 159, 79, 0.1); color: var(--primary); }

        /* URL Input */
        .upload-url-input { display: flex; gap: 12px; }
        .upload-url-input input { flex: 1; }
        .upload-status { margin-top: 10px; font-size: 13px; min-height: 20px; }
        .upload-status.loading { color: var(--accent); }
        .upload-status.success { color: var(--primary); }
        .upload-status.error { color: var(--danger); }

        /* Image Upload */
        .upload-image-drop { border: 2px dashed var(--dark-border); border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--dark); }
        .upload-image-drop:hover { border-color: var(--primary); background: rgba(13, 159, 79, 0.05); }
        .upload-image-drop.dragover { border-color: var(--primary); background: rgba(13, 159, 79, 0.1); }
        .upload-image-placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--text-muted); }
        .upload-image-icon { font-size: 40px; }
        .upload-image-hint { font-size: 12px; opacity: 0.7; }
        .upload-image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: contain; }

        /* Extracted Preview */
        .upload-preview { display: flex; gap: 16px; background: var(--dark); border-radius: 12px; padding: 16px; }
        .upload-preview-thumb { width: 160px; height: 90px; border-radius: 8px; object-fit: cover; background: var(--dark-border); flex-shrink: 0; }
        .upload-preview-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .upload-preview-title { font-weight: 700; font-size: 13px; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .upload-preview-channel { font-size: 12px; color: var(--primary); margin-bottom: 8px; }
        .upload-preview-stats { display: flex; flex-wrap: wrap; gap: 10px; font-size: 11px; color: var(--text-muted); }

        /* Credit Notice */
        .upload-credit-notice { display: flex; align-items: center; gap: 10px; background: rgba(13, 159, 79, 0.1); border: 1px solid rgba(13, 159, 79, 0.3); border-radius: 10px; padding: 12px 16px; margin-top: 16px; font-size: 12px; color: var(--primary); }
        .upload-credit-notice strong { color: var(--text); }

        /* Familia Grid */
        .upload-familia-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .upload-familia-option { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px 16px; background: var(--dark); border: 2px solid var(--dark-border); border-radius: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .upload-familia-option:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        .upload-familia-option.selected { border-color: var(--primary); background: rgba(13, 159, 79, 0.1); }
        .upload-familia-icon { font-size: 28px; }
        .upload-familia-name { font-size: 13px; font-weight: 600; }
        .upload-familia-extra { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--dark-border); }

        /* Temas Grid */
        .upload-temas-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .upload-tema-chip { padding: 8px 14px; background: var(--dark); border: 2px solid var(--dark-border); border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .upload-tema-chip:hover { border-color: var(--text-muted); }
        .upload-tema-chip.selected { border-color: var(--primary); background: rgba(13, 159, 79, 0.15); color: var(--primary); }

        /* Form Fields */
        .upload-field { margin-bottom: 16px; }
        .upload-field label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
        .upload-field input, .upload-field select, .upload-field textarea { width: 100%; padding: 12px 14px; background: var(--dark); border: 1px solid var(--dark-border); border-radius: 10px; color: var(--text); font-size: 14px; font-family: inherit; }
        .upload-field input:focus, .upload-field select:focus, .upload-field textarea:focus { outline: none; border-color: var(--primary); }
        .upload-field textarea { resize: vertical; min-height: 80px; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .upload-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

        /* Pizarra */
        .upload-pizarra { background: linear-gradient(135deg, rgba(245, 197, 24, 0.1) 0%, rgba(245, 197, 24, 0.05) 100%); border: 2px dashed var(--accent); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-pizarra:hover { background: rgba(245, 197, 24, 0.15); transform: translateY(-2px); }
        .upload-pizarra.has-image { border-style: solid; border-color: var(--primary); }
        .upload-pizarra-icon { font-size: 32px; margin-bottom: 8px; }
        .upload-pizarra-text { font-size: 14px; color: var(--accent); font-weight: 600; }
        .upload-pizarra-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* XP Bonus */
        .upload-xp-bonus { background: rgba(245, 197, 24, 0.1); padding: 14px 18px; border-radius: 12px; font-size: 14px; color: var(--accent); display: flex; align-items: center; gap: 10px; margin-top: 16px; }
        .upload-xp-bonus strong { color: var(--text); }

        /* Upload Footer */
        .upload-footer { padding: 20px 24px; border-top: 1px solid var(--dark-border); display: flex; gap: 12px; }
        .upload-footer .btn { flex: 1; justify-content: center; }
        .upload-footer .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 14px 24px; background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 12px; font-size: 14px; z-index: 3000; opacity: 0; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--primary); }
        .toast.error { border-color: var(--danger); }

        /* Footer */
        .footer { background: var(--dark-card); border-top: 1px solid var(--dark-border); padding: 40px 24px; text-align: center; margin-top: 60px; }
        .footer-text { color: var(--text-muted); font-size: 14px; }

        /* Responsive */
        @media (max-width: 1024px) { 
            .biblioteca { grid-template-columns: 1fr; } 
            .filters-sidebar { position: static; max-height: none; } 
        }

        @media (max-width: 768px) { 
            .header-inner { padding: 12px 16px; }
            .nav { display: none; } 
            .logo-text { font-size: 16px; }
            .logo-tube { font-size: 12px; padding: 2px 6px; }
            .logo-icon { width: 40px; height: 40px; font-size: 20px; }
            .notif-dropdown { width: 280px; right: -60px; }
            .user-stats-header { gap: 6px; margin-right: 4px; }
            .xp-badge, .racha-badge, .limit-badge { padding: 4px 8px; font-size: 10px; }
            .user-menu { padding: 6px 10px; gap: 8px; }
            .user-avatar { width: 32px; height: 32px; font-size: 12px; }
            .user-name { display: none; }
            .hero { padding: 100px 16px 60px; min-height: auto; }
            .hero-title-main { font-size: 32px; flex-direction: column; gap: 8px; }
            .hero-features { flex-direction: column; gap: 12px; }
            .hero-buttons { flex-direction: column; gap: 12px; }
            .btn-lg { padding: 14px 24px; font-size: 14px; width: 100%; justify-content: center; }
            .biblioteca { padding: 24px 16px; gap: 20px; }
            .biblioteca-header { flex-direction: column; align-items: stretch; }
            .biblioteca-search { width: 100%; }
            .ejercicios-grid { grid-template-columns: 1fr; }
            .session-fab { right: 16px; bottom: 16px; padding: 12px 16px; }
            .session-fab-content { display: none; }
            .session-drawer { width: 100%; right: -100%; }
            .modal-overlay { padding: 16px; }
            .modal-content { border-radius: 20px; max-height: 85vh; }
            .upload-modal { max-width: 100%; max-height: 100vh; border-radius: 0; }
            .upload-header { padding: 16px; }
            .upload-header h2 { font-size: 22px; }
            .upload-body { padding: 16px; }
            .upload-source-tabs { flex-direction: column; }
            .upload-preview { flex-direction: column; }
            .upload-preview-thumb { width: 100%; height: 140px; }
            .upload-familia-grid { grid-template-columns: 1fr; }
            .upload-grid { grid-template-columns: 1fr; }
            .upload-grid-3 { grid-template-columns: 1fr 1fr; }
            .upload-url-input { flex-direction: column; }
            .upload-footer { padding: 16px; flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
            .footer { padding: 24px 16px; margin-top: 40px; }
            .toast { bottom: 80px; max-width: calc(100% - 32px); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="logo" onclick="scrollToTop()">
                <div class="logo-icon">‚öΩ</div>
                <div class="logo-text">FUTBOL BASE <span class="logo-tube">TUBE</span></div>
            </div>
            <nav class="nav">
                <span class="nav-link active" onclick="scrollToSection('hero')">Inicio</span>
                <span class="nav-link" onclick="scrollToSection('biblioteca')">Biblioteca</span>
                <span class="nav-link" onclick="showMySessions()">Mis Sesiones</span>
                <span class="nav-link">Planes</span>
            </nav>
            <div class="header-actions" id="headerActions">
                <button class="btn btn-ghost" onclick="showAuthModal('login')">Entrar</button>
                <button class="btn btn-primary" onclick="showAuthModal('register')">üöÄ Registrarse</button>
            </div>
        </div>
    </header>

    <section class="hero" id="hero">
        <div class="hero-content">
            <div class="hero-badge">üåç La comunidad #1 de entrenadores de f√∫tbol</div>
            <h1 class="hero-title-main">
                FUTBOL BASE <span class="tube-logo"><span class="tube-text">TUBE</span></span>
            </h1>
            <p class="hero-tagline">LA MAYOR BIBLIOTECA DE EJERCICIOS DE F√öTBOL DEL PLANETA</p>
            <p class="hero-desc">Miles de videos de entrenamiento <strong>filtrados, organizados y etiquetados</strong> por una comunidad de entrenadores como t√∫. Encuentra el ejercicio perfecto en segundos, no en horas.</p>
            
            <div class="hero-features">
                <div class="hero-feature"><span class="hero-feature-icon">üîç</span><span>+12 filtros avanzados</span></div>
                <div class="hero-feature"><span class="hero-feature-icon">üë•</span><span>Creado por entrenadores reales</span></div>
                <div class="hero-feature"><span class="hero-feature-icon">üÜì</span><span>100% contenido gratuito</span></div>
            </div>
            
            <div class="hero-buttons">
                <button class="btn btn-primary btn-lg" onclick="scrollToSection('biblioteca')">üé¨ Explorar Ejercicios</button>
                <button class="btn btn-ghost btn-lg" id="btnUploadHero" onclick="showUploadModal()">üì§ Subir Ejercicio</button>
            </div>
            
            <div class="hero-stats">
                <div class="hero-stat"><div class="hero-stat-value" id="heroTotal">0</div><div class="hero-stat-label">Ejercicios</div></div>
                <div class="hero-stat"><div class="hero-stat-value" id="heroEntrenadores">0</div><div class="hero-stat-label">Entrenadores</div></div>
                <div class="hero-stat"><div class="hero-stat-value" id="heroCategorias">0</div><div class="hero-stat-label">Categor√≠as</div></div>
                <div class="hero-stat"><div class="hero-stat-value" id="heroUsuarios">+2K</div><div class="hero-stat-label">Usuarios</div></div>
            </div>
            
            <p class="hero-cta-text">¬øTienes un video de entrenamiento? <a href="#" onclick="showAuthModal('register')">Comp√°rtelo con la comunidad ‚Üí</a></p>
        </div>
    </section>

    <section class="biblioteca" id="biblioteca">
        <aside class="filters-sidebar">
            <div class="filters-header">
                <div class="filters-title">üéØ Filtros <span class="filters-badge" id="filtersBadge"></span></div>
                <span class="filters-clear" onclick="clearFilters()">Limpiar</span>
            </div>
            <div class="filter-group"><label class="filter-label">Categor√≠a</label><select class="filter-select" id="filterCategoria"><option value="">Todas</option></select></div>
            <div class="filter-group"><label class="filter-label">Dificultad</label><div class="difficulty-pills" id="filterDificultad"><div class="difficulty-pill" data-value="1">1</div><div class="difficulty-pill" data-value="2">2</div><div class="difficulty-pill" data-value="3">3</div><div class="difficulty-pill" data-value="4">4</div><div class="difficulty-pill" data-value="5">5</div></div></div>
            <div class="filter-group"><label class="filter-label">Entrenador</label><select class="filter-select" id="filterEntrenador"><option value="">Todos</option></select></div>
            <div class="filter-group"><label class="filter-label">Equipo</label><select class="filter-select" id="filterEquipo"><option value="">Todos</option></select></div>
            <div class="filter-group"><label class="filter-label">Idioma</label><select class="filter-select" id="filterIdioma"><option value="">Todos</option></select></div>
            <div class="filter-group"><label class="filter-label">Edad</label><select class="filter-select" id="filterEdad"><option value="">Todas</option></select></div>
            <div class="filter-group"><label class="filter-label">Duraci√≥n</label><select class="filter-select" id="filterDuracion"><option value="">Todas</option><option value="0-300">0-5 min</option><option value="300-600">5-10 min</option><option value="600-900">10-15 min</option><option value="900-1800">15-30 min</option><option value="1800-99999">30+ min</option></select></div>
            <div class="filter-group"><label class="filter-label">N¬∫ Jugadores</label><select class="filter-select" id="filterJugadores"><option value="">Todos</option></select></div>
            <div class="filter-group"><label class="filter-label">N¬∫ Porteros</label><select class="filter-select" id="filterPorteros"><option value="">Todos</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3+">3+</option></select></div>
            <div class="filter-group"><label class="filter-label">Popularidad (Likes)</label><select class="filter-select" id="filterLikes"><option value="">Todos</option><option value="0-100">0-100</option><option value="100-500">100-500</option><option value="500-1000">500-1K</option><option value="1000-10000">1K-10K</option><option value="10000-99999999">10K+</option></select></div>
            <div class="filter-group"><label class="filter-label">Vistas</label><select class="filter-select" id="filterVistas"><option value="">Todas</option><option value="0-1000">0-1K</option><option value="1000-10000">1K-10K</option><option value="10000-100000">10K-100K</option><option value="100000-1000000">100K-1M</option><option value="1000000-99999999">1M+</option></select></div>
            <div class="filter-group"><label class="filter-label">Fuente</label><select class="filter-select" id="filterFuente"><option value="">Todas</option><option value="youtube">üì∫ YouTube</option><option value="twitter">ùïè Twitter</option><option value="instagram">üì∑ Instagram</option></select></div>
        </aside>

        <main class="biblioteca-main">
            <div class="biblioteca-header">
                <div><h1 class="biblioteca-title">BIBLIOTECA DE EJERCICIOS</h1><p class="biblioteca-count">Mostrando <span id="exerciseCount">0</span> ejercicios</p></div>
                <div class="biblioteca-search"><span>üîç</span><input type="text" id="searchInput" placeholder="Buscar ejercicios..."></div>
            </div>
            <div class="ejercicios-grid" id="exerciseGrid"><div class="state-container"><div class="loading-spinner"></div><p>Cargando ejercicios...</p></div></div>
        </main>
    </section>

    <footer class="footer"><p class="footer-text">¬© 2024 Futbol Base TUBE. Creado por entrenadores, para entrenadores. üåç</p></footer>

    <!-- Floating Session Button -->
    <div class="session-fab" id="sessionFab" onclick="toggleSessionDrawer()">
        <div class="session-fab-icon">üèãÔ∏è</div>
        <div class="session-fab-content"><div class="session-fab-title">Mi Sesi√≥n</div><div class="session-fab-count"><span id="fabCount">0</span> ejercicios</div></div>
        <div class="session-fab-badge" id="fabBadge">0</div>
    </div>

    <!-- Session Drawer -->
    <div class="session-drawer-backdrop" id="drawerBackdrop" onclick="toggleSessionDrawer()"></div>
    <div class="session-drawer" id="sessionDrawer">
        <div class="session-drawer-header"><div class="session-drawer-title">üèãÔ∏è Mi Sesi√≥n</div><button class="session-drawer-close" onclick="toggleSessionDrawer()">‚úï</button></div>
        <div class="session-drawer-body" id="sessionBody"><div class="session-empty"><div class="session-empty-icon">üìã</div><div class="session-empty-text">A√±ade ejercicios desde la biblioteca<br>usando el bot√≥n ‚ûï</div></div></div>
        <div class="session-drawer-footer"><div class="session-stats"><span>Duraci√≥n total:</span><strong id="sessionDuration">0 min</strong></div><div class="session-actions"><button class="btn btn-ghost btn-sm" onclick="clearSession()">üóëÔ∏è Vaciar</button><button class="btn btn-primary btn-sm" onclick="saveSession()" id="btnSaveSession">üíæ Guardar</button></div></div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authOverlay" onclick="closeAuthModal(event)">
        <div class="modal-content auth-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeAuthModal()">√ó</button>
            <h2 class="auth-title" id="authTitle">BIENVENIDO</h2>
            <p class="auth-subtitle" id="authSubtitle">Accede a tu cuenta para guardar sesiones</p>
            <div class="auth-tabs"><div class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Entrar</div><div class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">Registrarse</div></div>
            <div class="auth-error" id="authError"></div>
            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <input type="text" class="auth-input" id="authName" placeholder="Tu nombre" style="display:none;">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Contrase√±a" required>
                <button type="submit" class="btn btn-primary" style="width:100%;" id="authSubmit">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Exercise Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div class="modal-video" id="modalVideo"></div>
            <div class="modal-body">
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="modal-tags" id="modalTags"></div>
                <div class="modal-info-grid" id="modalInfo"></div>
                <p class="modal-description" id="modalDesc"></p>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="modalAddSession" onclick="addCurrentToSession()">‚ûï A√±adir a Sesi√≥n</button>
                    <button class="btn btn-ghost" id="modalFavorite" onclick="toggleFavorite()">‚ù§Ô∏è Favorito</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Session Modal -->
    <div class="modal-overlay" id="saveOverlay" onclick="closeSaveModal(event)">
        <div class="modal-content save-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeSaveModal()">√ó</button>
            <h2 class="save-modal-title">üíæ Guardar Sesi√≥n</h2>
            <input type="text" class="auth-input" id="sessionName" placeholder="Nombre de la sesi√≥n">
            <div class="form-row"><input type="date" class="auth-input" id="sessionDate"><select class="auth-input" id="sessionCategoria"><option value="">Categor√≠a edad</option><option value="Prebenjam√≠n">Prebenjam√≠n</option><option value="Benjam√≠n">Benjam√≠n</option><option value="Alev√≠n">Alev√≠n</option><option value="Infantil">Infantil</option><option value="Cadete">Cadete</option><option value="Juvenil">Juvenil</option><option value="Senior">Senior</option></select></div>
            <input type="text" class="auth-input" id="sessionObjetivo" placeholder="Objetivo">
            <textarea class="auth-input" id="sessionNotas" placeholder="Notas adicionales" style="min-height:80px;"></textarea>
            <button class="btn btn-primary" style="width:100%;" onclick="confirmSaveSession()">üíæ Guardar Sesi√≥n</button>
        </div>
    </div>

    <!-- Add to Session Modal -->
    <div class="modal-overlay" id="addToSessionOverlay" onclick="closeAddToSessionModal(event)">
        <div class="modal-content save-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeAddToSessionModal()">√ó</button>
            <h2 class="save-modal-title">‚ûï A√±adir a Sesi√≥n</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">Selecciona la sesi√≥n:</p>
            <div class="sessions-list" id="sessionsListModal"><div class="session-list-loading">Cargando...</div></div>
            <div class="session-divider"><span>o crea una nueva</span></div>
            <button class="btn btn-ghost" style="width:100%;" onclick="createNewSessionFromModal()">‚ûï Crear nueva sesi√≥n</button>
        </div>
    </div>

    <!-- View Session Modal -->
    <div class="modal-overlay" id="viewSessionOverlay" onclick="closeViewSessionModal(event)">
        <div class="modal-content view-session-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeViewSessionModal()">√ó</button>
            <div class="view-session-header"><h2 class="view-session-title" id="viewSessionTitle"></h2><div class="view-session-meta" id="viewSessionMeta"></div></div>
            <div class="view-session-objetivo" id="viewSessionObjetivo"></div>
            <div class="view-session-exercises" id="viewSessionExercises"></div>
            <div class="view-session-footer"><button class="btn btn-primary" onclick="copySessionLink()">üîó Copiar Link</button><button class="btn btn-ghost" onclick="editCurrentSession()">‚úèÔ∏è Editar</button><button class="btn btn-danger btn-sm" onclick="deleteCurrentSession()">üóëÔ∏è</button></div>
        </div>
    </div>

    <!-- My Sessions Modal -->
    <div class="modal-overlay" id="mySessionsOverlay" onclick="closeMySessionsModal(event)">
        <div class="modal-content my-sessions-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeMySessionsModal()">√ó</button>
            <div class="my-sessions-header"><h2 class="save-modal-title">üìã Mis Sesiones</h2><button class="btn btn-primary btn-sm" onclick="closeMySessionsModal();saveSession();">‚ûï Nueva</button></div>
            <div class="my-sessions-list" id="mySessionsList"><div class="session-list-loading">Cargando...</div></div>
        </div>
    </div>

    <!-- Upload Exercise Modal - NEW -->
    <div class="modal-overlay" id="uploadOverlay" onclick="closeUploadModal(event)">
        <div class="modal-content upload-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeUploadModal()">√ó</button>
            
            <div class="upload-header">
                <h2>üì§ SUBIR EJERCICIO</h2>
                <p>Comparte contenido de entrenamiento con la comunidad</p>
            </div>
            
            <div class="upload-body">
                
                <!-- PASO 1: Fuente del contenido -->
                <div class="upload-section">
                    <div class="upload-section-title">1Ô∏è‚É£ Fuente del Contenido *</div>
                    <div class="upload-source-tabs">
                        <button class="upload-source-tab active" onclick="setUploadSource('video')">üì∫ URL de Video</button>
                        <button class="upload-source-tab" onclick="setUploadSource('imagen')">üñºÔ∏è Subir Imagen</button>
                    </div>
                    
                    <!-- Opci√≥n Video -->
                    <div class="upload-source-content" id="uploadSourceVideo">
                        <div class="upload-url-input">
                            <input type="text" class="auth-input" id="uploadUrl" placeholder="https://youtube.com/watch?v=...">
                            <button class="btn btn-primary" onclick="extractVideoInfo()">Extraer</button>
                        </div>
                        <div class="upload-status" id="uploadStatus"></div>
                    </div>
                    
                    <!-- Opci√≥n Imagen -->
                    <div class="upload-source-content" id="uploadSourceImagen" style="display:none;">
                        <div class="upload-image-drop" id="uploadImageDrop" onclick="document.getElementById('uploadImageInput').click()">
                            <input type="file" id="uploadImageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                            <div class="upload-image-placeholder" id="uploadImagePlaceholder">
                                <span class="upload-image-icon">üì∑</span>
                                <span>Haz clic o arrastra una imagen</span>
                                <span class="upload-image-hint">JPG, PNG - M√°x 5MB</span>
                            </div>
                            <img id="uploadImagePreview" class="upload-image-preview" style="display:none;">
                        </div>
                    </div>
                </div>
                
                <!-- Datos extra√≠dos del video -->
                <div class="upload-section upload-extracted" id="uploadExtracted" style="display:none;">
                    <div class="upload-section-title">üì∫ Datos del Video (autom√°tico)</div>
                    <div class="upload-preview">
                        <img class="upload-preview-thumb" id="uploadThumb" src="">
                        <div class="upload-preview-info">
                            <div class="upload-preview-title" id="uploadPreviewTitle"></div>
                            <div class="upload-preview-channel" id="uploadPreviewChannel"></div>
                            <div class="upload-preview-stats">
                                <span id="uploadPreviewViews">üëÅÔ∏è 0</span>
                                <span id="uploadPreviewLikes">üëç 0</span>
                                <span id="uploadPreviewDuration">‚è±Ô∏è 0:00</span>
                                <span id="uploadPreviewLang">üåê</span>
                            </div>
                        </div>
                    </div>
                    <div class="upload-credit-notice">
                        <span>‚úÖ</span>
                        <span>El contenido ser√° atribuido a <strong id="uploadCreditChannel">-</strong> con enlace al video original</span>
                    </div>
                </div>
                
                <!-- PASO 2: Familia -->
                <div class="upload-section" id="uploadFamiliaSection" style="display:none;">
                    <div class="upload-section-title">2Ô∏è‚É£ Familia del Contenido *</div>
                    <div class="upload-familia-grid">
                        <div class="upload-familia-option" onclick="selectFamilia('futbol_base')"><span class="upload-familia-icon">‚öΩ</span><span class="upload-familia-name">F√∫tbol Base</span></div>
                        <div class="upload-familia-option" onclick="selectFamilia('profesional')"><span class="upload-familia-icon">üèüÔ∏è</span><span class="upload-familia-name">Equipo/Entrenador Profesional</span></div>
                        <div class="upload-familia-option" onclick="selectFamilia('entrevista')"><span class="upload-familia-icon">üé§</span><span class="upload-familia-name">Entrevista</span></div>
                        <div class="upload-familia-option" onclick="selectFamilia('analisis')"><span class="upload-familia-icon">üìä</span><span class="upload-familia-name">An√°lisis T√°ctico</span></div>
                    </div>
                    
                    <!-- Campos extra Profesional -->
                    <div class="upload-familia-extra" id="familiaExtraProfesional" style="display:none;">
                        <div class="upload-grid">
                            <div class="upload-field">
                                <label>Entrenador</label>
                                <select id="uploadEntrenador">
                                    <option value="">Seleccionar...</option>
                                    <option value="Pep Guardiola">Pep Guardiola</option>
                                    <option value="J√ºrgen Klopp">J√ºrgen Klopp</option>
                                    <option value="Carlo Ancelotti">Carlo Ancelotti</option>
                                    <option value="Diego Simeone">Diego Simeone</option>
                                    <option value="Xavi Hern√°ndez">Xavi Hern√°ndez</option>
                                    <option value="Mikel Arteta">Mikel Arteta</option>
                                    <option value="Luis Enrique">Luis Enrique</option>
                                    <option value="Unai Emery">Unai Emery</option>
                                    <option value="Julian Nagelsmann">Julian Nagelsmann</option>
                                    <option value="Thomas Tuchel">Thomas Tuchel</option>
                                    <option value="Hansi Flick">Hansi Flick</option>
                                    <option value="Zinedine Zidane">Zinedine Zidane</option>
                                    <option value="Mauricio Pochettino">Mauricio Pochettino</option>
                                    <option value="Erik ten Hag">Erik ten Hag</option>
                                    <option value="Roberto De Zerbi">Roberto De Zerbi</option>
                                    <option value="Xabi Alonso">Xabi Alonso</option>
                                    <option value="Marcelo Bielsa">Marcelo Bielsa</option>
                                    <option value="Arne Slot">Arne Slot</option>
                                    <option value="Ruben Amorim">Ruben Amorim</option>
                                    <option value="Vincent Kompany">Vincent Kompany</option>
                                    <option value="_otro">Otro...</option>
                                </select>
                            </div>
                            <div class="upload-field">
                                <label>Equipo</label>
                                <select id="uploadEquipo">
                                    <option value="">Seleccionar...</option>
                                    <optgroup label="üá™üá∏ Espa√±a"><option value="FC Barcelona">FC Barcelona</option><option value="Real Madrid">Real Madrid</option><option value="Atl√©tico Madrid">Atl√©tico Madrid</option><option value="Athletic Bilbao">Athletic Bilbao</option><option value="Real Sociedad">Real Sociedad</option><option value="Sevilla FC">Sevilla FC</option><option value="Valencia CF">Valencia CF</option><option value="Villarreal CF">Villarreal CF</option><option value="Real Betis">Real Betis</option></optgroup>
                                    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Inglaterra"><option value="Manchester City">Manchester City</option><option value="Liverpool">Liverpool</option><option value="Arsenal">Arsenal</option><option value="Chelsea">Chelsea</option><option value="Manchester United">Manchester United</option><option value="Tottenham">Tottenham</option><option value="Aston Villa">Aston Villa</option><option value="Brighton">Brighton</option><option value="Newcastle">Newcastle</option></optgroup>
                                    <optgroup label="üá©üá™ Alemania"><option value="Bayern Munich">Bayern Munich</option><option value="Borussia Dortmund">Borussia Dortmund</option><option value="RB Leipzig">RB Leipzig</option><option value="Bayer Leverkusen">Bayer Leverkusen</option></optgroup>
                                    <optgroup label="üáÆüáπ Italia"><option value="Juventus">Juventus</option><option value="AC Milan">AC Milan</option><option value="Inter Milan">Inter Milan</option><option value="Napoli">Napoli</option><option value="AS Roma">AS Roma</option><option value="Atalanta">Atalanta</option></optgroup>
                                    <optgroup label="üá´üá∑ Francia"><option value="PSG">PSG</option><option value="Olympique Lyon">Olympique Lyon</option><option value="Olympique Marsella">Olympique Marsella</option><option value="AS Monaco">AS Monaco</option></optgroup>
                                    <optgroup label="üåç Selecciones"><option value="Espa√±a">Espa√±a</option><option value="Alemania">Alemania</option><option value="Francia">Francia</option><option value="Inglaterra">Inglaterra</option><option value="Italia">Italia</option><option value="Argentina">Argentina</option><option value="Brasil">Brasil</option><option value="Portugal">Portugal</option></optgroup>
                                    <option value="_otro">Otro...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos extra An√°lisis -->
                    <div class="upload-familia-extra" id="familiaExtraAnalisis" style="display:none;">
                        <div class="upload-field">
                            <label>Sistema de Juego</label>
                            <select id="uploadSistema">
                                <option value="">Seleccionar sistema...</option>
                                <optgroup label="4 Defensas"><option value="4-4-2">4-4-2</option><option value="4-4-2 Rombo">4-4-2 Rombo</option><option value="4-3-3">4-3-3</option><option value="4-2-3-1">4-2-3-1</option><option value="4-1-4-1">4-1-4-1</option><option value="4-3-1-2">4-3-1-2</option><option value="4-1-2-1-2">4-1-2-1-2</option></optgroup>
                                <optgroup label="3 Defensas"><option value="3-5-2">3-5-2</option><option value="3-4-3">3-4-3</option><option value="3-4-2-1">3-4-2-1</option><option value="3-1-4-2">3-1-4-2</option></optgroup>
                                <optgroup label="5 Defensas"><option value="5-3-2">5-3-2</option><option value="5-4-1">5-4-1</option><option value="5-2-3">5-2-3</option></optgroup>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- PASO 3: Descripci√≥n -->
                <div class="upload-section" id="uploadDescSection" style="display:none;">
                    <div class="upload-section-title">3Ô∏è‚É£ Tu Aportaci√≥n</div>
                    <div class="upload-field">
                        <label>Describe el ejercicio con tus palabras <span class="upload-bonus">(+10 XP extra)</span></label>
                        <textarea id="uploadDescripcion" placeholder="Ej: Ejercicio de posesi√≥n donde se trabaja la salida de bal√≥n con presi√≥n alta del rival..." rows="3"></textarea>
                    </div>
                </div>
                
                <!-- PASO 4: Temas trabajados -->
                <div class="upload-section" id="uploadTemasSection" style="display:none;">
                    <div class="upload-section-title">4Ô∏è‚É£ Temas Trabajados * <span class="upload-hint">(selecciona 1-5)</span></div>
                    <div class="upload-temas-grid" id="uploadTemas"></div>
                </div>
                
                <!-- PASO 5: Detalles -->
                <div class="upload-section" id="uploadDetallesSection" style="display:none;">
                    <div class="upload-section-title">5Ô∏è‚É£ Detalles Adicionales</div>
                    <div class="upload-grid">
                        <div class="upload-field"><label>Dificultad *</label><select id="uploadDificultad"><option value="">Seleccionar</option><option value="1">1 - Muy f√°cil</option><option value="2">2 - F√°cil</option><option value="3">3 - Intermedio</option><option value="4">4 - Dif√≠cil</option><option value="5">5 - Muy dif√≠cil</option></select></div>
                        <div class="upload-field"><label>Edad recomendada</label><select id="uploadEdad"><option value="">Seleccionar</option><option value="Prebenjam√≠n">Prebenjam√≠n (5-7)</option><option value="Benjam√≠n">Benjam√≠n (8-9)</option><option value="Alev√≠n">Alev√≠n (10-11)</option><option value="Infantil">Infantil (12-13)</option><option value="Cadete">Cadete (14-15)</option><option value="Juvenil">Juvenil (16-18)</option><option value="Senior">Senior (19+)</option><option value="Profesional">Profesional</option></select></div>
                    </div>
                    <div class="upload-grid-3">
                        <div class="upload-field"><label>N¬∫ Jugadores</label><select id="uploadJugadores"><option value="">-</option><option value="2-4">2-4</option><option value="5-8">5-8</option><option value="9-12">9-12</option><option value="13-16">13-16</option><option value="17-20">17-20</option><option value="20+">20+</option></select></div>
                        <div class="upload-field"><label>N¬∫ Porteros</label><select id="uploadPorteros"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3+</option></select></div>
                        <div class="upload-field"><label>Dimensiones</label><select id="uploadDimensiones"><option value="">-</option><option value="10x10m">10x10m</option><option value="15x15m">15x15m</option><option value="20x20m">20x20m</option><option value="30x30m">30x30m</option><option value="Medio campo">Medio campo</option><option value="Campo completo">Campo completo</option></select></div>
                    </div>
                </div>
                
                <!-- Pizarra T√°ctica -->
                <div class="upload-section" id="uploadPizarraSection" style="display:none;">
                    <div class="upload-field">
                        <label>üé® Imagen de Pizarra T√°ctica (opcional)</label>
                        <div class="upload-pizarra" id="uploadPizarraBox" onclick="openPizarra()">
                            <div class="upload-pizarra-icon">üé®</div>
                            <div class="upload-pizarra-text">Crear imagen con Pizarra T√°ctica</div>
                            <div class="upload-pizarra-hint">+50 XP extra si incluyes imagen</div>
                        </div>
                    </div>
                    
                    <div class="upload-xp-bonus" id="uploadXpBonus">
                        <span>‚≠ê</span>
                        <span>Ganar√°s <strong id="uploadXpTotal">+50 XP</strong> cuando se apruebe</span>
                    </div>
                </div>
            </div>
            
            <div class="upload-footer">
                <button class="btn btn-ghost" onclick="closeUploadModal()">Cancelar</button>
                <button class="btn btn-primary" id="btnSubmitExercise" onclick="submitExercise()" disabled>üì§ Enviar Ejercicio</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIG ====================
        var SUPABASE_URL = localStorage.getItem('sb_url') || '';
        var SUPABASE_KEY = localStorage.getItem('sb_key') || '';
        var YT_API_KEY = localStorage.getItem('yt_key') || '';
        var db = null;
        var currentUser = null;
        var currentExercise = null;
        var currentSession = [];
        var exercises = [];
        var filters = {};
        var notifications = [];

        // ==================== TEMAS TRABAJADOS ====================
        var TEMAS_TRABAJADOS = [
            'Rondos', 'Posesi√≥n', 'Finalizaci√≥n', 'Pressing', 'Transiciones', 'Porteros', 'Calentamiento',
            'Pase', 'Control', 'Conducci√≥n', 'Regate', 'Defensa', 'Ataque',
            'Juego Posicional', 'Salida de Bal√≥n', 'Pressing Alto', 'Gegenpressing',
            'Superioridades', 'Tercer Hombre', 'Juego Entre L√≠neas', 'Basculaciones',
            'Coberturas y Permutas', 'Desmarques', 'Cambios de Orientaci√≥n', 'Periodizaci√≥n T√°ctica',
            'SSG', 'Trabajo Cognitivo', 'Toma de Decisiones', '1v1 / Duelos', 'Oleadas',
            'Circuitos T√©cnicos', 'Estrategia (ABP)', 'Repliegue', 'Amplitud y Profundidad', 'Sincronizaci√≥n de L√≠neas'
        ];

        var LANG_FLAGS = { 'es': 'üá™üá∏', 'en': 'üá¨üáß', 'pt': 'üáµüáπ', 'it': 'üáÆüáπ', 'de': 'üá©üá™', 'fr': 'üá´üá∑', 'nl': 'üá≥üá±', 'other': 'üåê' };
        var LANG_NAMES = { 'es': 'Espa√±ol', 'en': 'Ingl√©s', 'pt': 'Portugu√©s', 'it': 'Italiano', 'de': 'Alem√°n', 'fr': 'Franc√©s', 'nl': 'Holand√©s', 'other': 'Otro' };

        // ==================== UPLOAD STATE ====================
        var uploadSource = 'video';
        var uploadData = {};
        var selectedFamilia = null;
        var selectedTemas = [];
        var uploadedImageFile = null;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            if (SUPABASE_URL && SUPABASE_KEY) {
                db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                checkAuth();
                loadExercises();
                loadFilters();
            } else {
                showConfigPrompt();
            }
            setupEventListeners();
            initUploadTemas();
        });

        function showConfigPrompt() {
            document.getElementById('exerciseGrid').innerHTML = '<div class="state-container"><div class="state-icon">‚öôÔ∏è</div><div class="state-title">Configuraci√≥n necesaria</div><p class="state-text">Configura Supabase en el <a href="admin.html">panel admin</a></p></div>';
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(loadExercises, 300));
            document.querySelectorAll('.filter-select').forEach(function(s) { s.addEventListener('change', loadExercises); });
            document.querySelectorAll('.difficulty-pill').forEach(function(p) {
                p.addEventListener('click', function() {
                    var active = this.classList.contains('active');
                    document.querySelectorAll('.difficulty-pill').forEach(function(x) { x.classList.remove('active'); });
                    if (!active) this.classList.add('active');
                    loadExercises();
                });
            });
        }

        function debounce(fn, wait) { var t; return function() { clearTimeout(t); t = setTimeout(fn, wait); }; }

        // ==================== AUTH ====================
        async function checkAuth() {
            if (!db) return;
            var { data: { user } } = await db.auth.getUser();
            if (user) {
                currentUser = user;
                var { data: perfil } = await db.from('perfiles').select('*').eq('id', user.id).single();
                if (perfil) currentUser.perfil = perfil;
                updateUIForUser();
                loadNotifications();
            }
        }

        function updateUIForUser() {
            var u = currentUser;
            var p = u.perfil || {};
            var plan = p.plan || 'free';
            var planBadge = plan === 'coach' ? '<span class="plan-badge coach">COACH</span>' : (plan === 'pro' ? '<span class="plan-badge pro">PRO</span>' : '');
            
            document.getElementById('headerActions').innerHTML = 
                '<div class="user-stats-header">' +
                    '<span class="xp-badge">‚≠ê ' + (p.xp || 0) + ' XP</span>' +
                    '<span class="racha-badge">üî• ' + (p.racha_dias || 0) + '</span>' +
                '</div>' +
                '<div class="notif-bell" onclick="toggleNotifications()">' +
                    '<span class="notif-bell-icon">üîî</span>' +
                    '<span class="notif-badge" id="notifBadge">0</span>' +
                    '<div class="notif-dropdown" id="notifDropdown">' +
                        '<div class="notif-header"><span class="notif-header-title">Notificaciones</span><span class="notif-header-action" onclick="markAllRead()">Marcar le√≠das</span></div>' +
                        '<div class="notif-list" id="notifList"></div>' +
                    '</div>' +
                '</div>' +
                '<div class="user-menu" onclick="toggleUserMenu()">' +
                    '<div class="user-avatar">' + (p.nombre || u.email)[0].toUpperCase() + '</div>' +
                    '<span class="user-name">' + (p.nombre || u.email.split('@')[0]) + planBadge + '</span>' +
                    '<div class="user-dropdown" id="userDropdown">' +
                        '<div class="user-dropdown-header"><div class="user-dropdown-level">Nivel ' + (p.nivel || 1) + ' - ' + (p.titulo || 'Novato') + '</div><div class="user-dropdown-xp">' + (p.xp || 0) + ' XP</div></div>' +
                        '<div class="user-dropdown-item" onclick="showMySessions()">üìã Mis Sesiones</div>' +
                        '<div class="user-dropdown-item" onclick="showUploadModal()">üì§ Subir Ejercicio</div>' +
                        (plan === 'coach' ? '<div class="user-dropdown-item" onclick="location.href=\'admin.html\'">‚öôÔ∏è Admin</div>' : '') +
                        '<div class="user-dropdown-item danger" onclick="logout()">üö™ Cerrar Sesi√≥n</div>' +
                    '</div>' +
                '</div>';
        }

        function toggleUserMenu() { document.getElementById('userDropdown').classList.toggle('show'); }

        async function logout() {
            await db.auth.signOut();
            currentUser = null;
            location.reload();
        }

        function showAuthModal(tab) {
            document.getElementById('authOverlay').classList.add('active');
            switchAuthTab(tab || 'login');
        }

        function closeAuthModal(e) { if (!e || e.target === e.currentTarget) document.getElementById('authOverlay').classList.remove('active'); }

        function switchAuthTab(tab) {
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
            document.getElementById('authName').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authSubmit').textContent = tab === 'login' ? 'Entrar' : 'Registrarse';
            document.getElementById('authTitle').textContent = tab === 'login' ? 'BIENVENIDO' : '√öNETE';
        }

        async function handleAuth(e) {
            e.preventDefault();
            var email = document.getElementById('authEmail').value;
            var pass = document.getElementById('authPassword').value;
            var name = document.getElementById('authName').value;
            var isRegister = document.getElementById('tabRegister').classList.contains('active');
            
            try {
                if (isRegister) {
                    var { data, error } = await db.auth.signUp({ email: email, password: pass });
                    if (error) throw error;
                    if (data.user) {
                        await db.from('perfiles').insert({ id: data.user.id, nombre: name, plan: 'free', xp: 0, nivel: 1 });
                    }
                    showToast('‚úÖ Registro exitoso. Revisa tu email.', 'success');
                } else {
                    var { data, error } = await db.auth.signInWithPassword({ email: email, password: pass });
                    if (error) throw error;
                    showToast('‚úÖ Bienvenido!', 'success');
                }
                closeAuthModal();
                checkAuth();
            } catch (err) {
                document.getElementById('authError').textContent = err.message;
                document.getElementById('authError').classList.add('show');
            }
        }

        // ==================== NOTIFICATIONS ====================
        async function loadNotifications() {
            if (!db || !currentUser) return;
            var { data } = await db.from('notificaciones').select('*').eq('usuario_id', currentUser.id).order('created_at', { ascending: false }).limit(20);
            notifications = data || [];
            renderNotifications();
        }

        function renderNotifications() {
            var unread = notifications.filter(function(n) { return !n.leida; }).length;
            var badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = unread;
                badge.classList.toggle('show', unread > 0);
            }
            var list = document.getElementById('notifList');
            if (!list) return;
            if (!notifications.length) {
                list.innerHTML = '<div class="notif-empty"><div class="notif-empty-icon">üîî</div><p>No hay notificaciones</p></div>';
                return;
            }
            list.innerHTML = notifications.map(function(n) {
                return '<div class="notif-item ' + (n.leida ? '' : 'unread') + '" onclick="openNotification(\'' + n.id + '\')">' +
                    '<div class="notif-item-title">' + n.titulo + '</div>' +
                    '<div class="notif-item-message">' + n.mensaje + '</div>' +
                    '<div class="notif-item-time">' + getTimeAgo(n.created_at) + '</div>' +
                '</div>';
            }).join('');
        }

        function toggleNotifications() {
            document.getElementById('notifDropdown').classList.toggle('show');
            document.getElementById('userDropdown').classList.remove('show');
        }

        async function openNotification(id) {
            await db.from('notificaciones').update({ leida: true }).eq('id', id);
            loadNotifications();
            showToast('Notificaci√≥n marcada como le√≠da', 'success');
        }

        async function markAllRead() {
            if (!currentUser) return;
            await db.from('notificaciones').update({ leida: true }).eq('usuario_id', currentUser.id);
            loadNotifications();
        }

        function getTimeAgo(date) {
            var mins = Math.floor((Date.now() - new Date(date)) / 60000);
            if (mins < 60) return mins + ' min';
            if (mins < 1440) return Math.floor(mins / 60) + ' h';
            return Math.floor(mins / 1440) + ' d';
        }

        // ==================== EXERCISES ====================
        async function loadExercises() {
            if (!db) return;
            var grid = document.getElementById('exerciseGrid');
            grid.innerHTML = '<div class="state-container"><div class="loading-spinner"></div><p>Cargando...</p></div>';
            
            var query = db.from('ejercicios').select('*').eq('estado', 'publicado').order('created_at', { ascending: false });
            
            var search = document.getElementById('searchInput').value.trim();
            if (search) query = query.ilike('titulo_ejercicio', '%' + search + '%');
            
            var cat = document.getElementById('filterCategoria').value;
            if (cat) query = query.contains('categorias', [cat]);
            
            var dif = document.querySelector('.difficulty-pill.active');
            if (dif) query = query.eq('dificultad', parseInt(dif.dataset.value));
            
            var ent = document.getElementById('filterEntrenador').value;
            if (ent) query = query.eq('entrenador', ent);
            
            var equipo = document.getElementById('filterEquipo').value;
            if (equipo) query = query.eq('equipo', equipo);
            
            var idioma = document.getElementById('filterIdioma').value;
            if (idioma) query = query.eq('idioma', idioma);
            
            var edad = document.getElementById('filterEdad').value;
            if (edad) query = query.eq('edad', edad);
            
            var fuente = document.getElementById('filterFuente').value;
            if (fuente) query = query.eq('source', fuente);
            
            var { data, error } = await query.limit(50);
            
            if (error) { grid.innerHTML = '<div class="state-container"><div class="state-icon">‚ùå</div><p>' + error.message + '</p></div>'; return; }
            
            exercises = data || [];
            renderExercises();
            updateStats();
        }

        function renderExercises() {
            var grid = document.getElementById('exerciseGrid');
            if (!exercises.length) {
                grid.innerHTML = '<div class="state-container"><div class="state-icon">üîç</div><div class="state-title">No hay ejercicios</div><p class="state-text">Prueba con otros filtros</p></div>';
                return;
            }
            
            grid.innerHTML = exercises.map(function(ex) {
                var cats = (ex.categorias || []).slice(0, 2).map(function(c) { return '<span class="ejercicio-tag">' + c + '</span>'; }).join('');
                var inSession = currentSession.some(function(s) { return s.id === ex.id; });
                return '<div class="ejercicio-card" onclick="openExercise(\'' + ex.id + '\')">' +
                    '<div class="ejercicio-thumbnail">' +
                        '<img src="' + (ex.thumbnail_url || 'https://via.placeholder.com/320x180/16162a/8b8ba7?text=Video') + '" alt="">' +
                        '<div class="ejercicio-play"></div>' +
                        (ex.dificultad ? '<div class="ejercicio-difficulty">Dif ' + ex.dificultad + '</div>' : '') +
                        '<div class="ejercicio-lang">' + (LANG_FLAGS[ex.idioma] || 'üåê') + '</div>' +
                        (ex.duracion ? '<div class="ejercicio-duration">' + ex.duracion + '</div>' : '') +
                    '</div>' +
                    '<div class="ejercicio-body">' +
                        '<h3 class="ejercicio-title">' + (ex.titulo_ejercicio || ex.titulo_video) + '</h3>' +
                        '<p class="ejercicio-meta">' + (ex.entrenador || ex.canal || '-') + (ex.equipo ? ' ‚Ä¢ ' + ex.equipo : '') + '</p>' +
                        '<div class="ejercicio-tags">' + cats + '</div>' +
                        '<div class="ejercicio-footer">' +
                            '<div class="ejercicio-stats"><span class="ejercicio-stat">üëÅÔ∏è ' + formatNumber(ex.vistas || 0) + '</span><span class="ejercicio-stat">üëç ' + formatNumber(ex.likes || 0) + '</span></div>' +
                            '<div class="ejercicio-actions">' +
                                '<button class="ejercicio-action ' + (inSession ? 'in-session' : '') + '" onclick="event.stopPropagation();toggleInSession(\'' + ex.id + '\')">' + (inSession ? '‚úì' : '+') + '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            
            document.getElementById('exerciseCount').textContent = exercises.length;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n;
        }

        async function updateStats() {
            if (!db) return;
            var { count } = await db.from('ejercicios').select('*', { count: 'exact', head: true }).eq('estado', 'publicado');
            document.getElementById('heroTotal').textContent = count || 0;
            
            var { data: ents } = await db.from('ejercicios').select('entrenador').eq('estado', 'publicado').not('entrenador', 'is', null);
            var uniqueEnts = [...new Set((ents || []).map(function(e) { return e.entrenador; }).filter(Boolean))];
            document.getElementById('heroEntrenadores').textContent = uniqueEnts.length;
            
            var { data: cats } = await db.from('ejercicios').select('categorias').eq('estado', 'publicado');
            var allCats = (cats || []).flatMap(function(c) { return c.categorias || []; });
            var uniqueCats = [...new Set(allCats)];
            document.getElementById('heroCategorias').textContent = uniqueCats.length;
        }

        async function loadFilters() {
            if (!db) return;
            var { data } = await db.from('ejercicios').select('categorias, entrenador, equipo, idioma, edad, jugadores').eq('estado', 'publicado');
            if (!data) return;
            
            var cats = [...new Set(data.flatMap(function(d) { return d.categorias || []; }))].sort();
            var ents = [...new Set(data.map(function(d) { return d.entrenador; }).filter(Boolean))].sort();
            var equipos = [...new Set(data.map(function(d) { return d.equipo; }).filter(Boolean))].sort();
            var idiomas = [...new Set(data.map(function(d) { return d.idioma; }).filter(Boolean))];
            var edades = [...new Set(data.map(function(d) { return d.edad; }).filter(Boolean))];
            var jugadores = [...new Set(data.map(function(d) { return d.jugadores; }).filter(Boolean))];
            
            populateSelect('filterCategoria', cats);
            populateSelect('filterEntrenador', ents);
            populateSelect('filterEquipo', equipos);
            populateSelect('filterIdioma', idiomas.map(function(i) { return { value: i, label: (LANG_FLAGS[i] || 'üåê') + ' ' + (LANG_NAMES[i] || i) }; }));
            populateSelect('filterEdad', edades);
            populateSelect('filterJugadores', jugadores);
        }

        function populateSelect(id, options) {
            var sel = document.getElementById(id);
            var first = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(first);
            options.forEach(function(o) {
                var opt = document.createElement('option');
                if (typeof o === 'object') { opt.value = o.value; opt.textContent = o.label; }
                else { opt.value = o; opt.textContent = o; }
                sel.appendChild(opt);
            });
        }

        function clearFilters() {
            document.querySelectorAll('.filter-select').forEach(function(s) { s.value = ''; });
            document.querySelectorAll('.difficulty-pill').forEach(function(p) { p.classList.remove('active'); });
            document.getElementById('searchInput').value = '';
            loadExercises();
        }

        // ==================== EXERCISE MODAL ====================
        function openExercise(id) {
            currentExercise = exercises.find(function(e) { return e.id === id; });
            if (!currentExercise) return;
            
            var ex = currentExercise;
            document.getElementById('modalTitle').textContent = ex.titulo_ejercicio || ex.titulo_video;
            
            var videoHtml = '';
            if (ex.source === 'youtube' && ex.video_id) {
                videoHtml = '<iframe src="https://www.youtube.com/embed/' + ex.video_id + '?autoplay=1" allowfullscreen></iframe>';
            } else if (ex.source === 'twitter' && ex.tweet_embed_html) {
                videoHtml = '<div style="padding:20px;background:#15202b;">' + ex.tweet_embed_html + '</div>';
            } else {
                videoHtml = '<div style="display:flex;align-items:center;justify-content:center;height:100%;"><a href="' + ex.video_url + '" target="_blank" class="btn btn-primary">‚ñ∂ Ver Video</a></div>';
            }
            document.getElementById('modalVideo').innerHTML = videoHtml;
            
            var tags = (ex.categorias || []).map(function(c) { return '<span class="modal-tag">' + c + '</span>'; }).join('');
            if (ex.dificultad) tags += '<span class="modal-tag dif">Dificultad ' + ex.dificultad + '</span>';
            document.getElementById('modalTags').innerHTML = tags;
            
            var info = '';
            if (ex.entrenador) info += '<div class="modal-info-item"><div class="modal-info-icon">üë®‚Äçüè´</div><div class="modal-info-value">' + ex.entrenador + '</div><div class="modal-info-label">Entrenador</div></div>';
            if (ex.equipo) info += '<div class="modal-info-item"><div class="modal-info-icon">üèüÔ∏è</div><div class="modal-info-value">' + ex.equipo + '</div><div class="modal-info-label">Equipo</div></div>';
            if (ex.duracion) info += '<div class="modal-info-item"><div class="modal-info-icon">‚è±Ô∏è</div><div class="modal-info-value">' + ex.duracion + '</div><div class="modal-info-label">Duraci√≥n</div></div>';
            if (ex.jugadores) info += '<div class="modal-info-item"><div class="modal-info-icon">üë•</div><div class="modal-info-value">' + ex.jugadores + '</div><div class="modal-info-label">Jugadores</div></div>';
            if (ex.edad) info += '<div class="modal-info-item"><div class="modal-info-icon">üìÖ</div><div class="modal-info-value">' + ex.edad + '</div><div class="modal-info-label">Edad</div></div>';
            document.getElementById('modalInfo').innerHTML = info;
            
            document.getElementById('modalDesc').textContent = ex.descripcion || '';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal(e) { if (!e || e.target === e.currentTarget) { document.getElementById('modalOverlay').classList.remove('active'); document.getElementById('modalVideo').innerHTML = ''; } }

        // ==================== SESSION ====================
        function toggleInSession(id) {
            var ex = exercises.find(function(e) { return e.id === id; });
            if (!ex) return;
            var idx = currentSession.findIndex(function(s) { return s.id === id; });
            if (idx === -1) { currentSession.push(ex); showToast('‚ûï A√±adido a la sesi√≥n', 'success'); }
            else { currentSession.splice(idx, 1); showToast('‚ûñ Quitado de la sesi√≥n', 'success'); }
            updateSessionUI();
            renderExercises();
        }

        function addCurrentToSession() {
            if (!currentExercise) return;
            toggleInSession(currentExercise.id);
        }

        function updateSessionUI() {
            var count = currentSession.length;
            document.getElementById('fabCount').textContent = count;
            document.getElementById('fabBadge').textContent = count;
            document.getElementById('sessionFab').classList.toggle('has-items', count > 0);
            
            var dur = currentSession.reduce(function(t, e) { return t + (e.duracion_segundos || 0); }, 0);
            document.getElementById('sessionDuration').textContent = Math.round(dur / 60) + ' min';
            
            var body = document.getElementById('sessionBody');
            if (!count) {
                body.innerHTML = '<div class="session-empty"><div class="session-empty-icon">üìã</div><div class="session-empty-text">A√±ade ejercicios desde la biblioteca</div></div>';
                return;
            }
            body.innerHTML = currentSession.map(function(ex, i) {
                return '<div class="session-item">' +
                    '<span class="session-item-drag">‚ò∞</span>' +
                    '<img class="session-item-thumb" src="' + (ex.thumbnail_url || '') + '">' +
                    '<div class="session-item-info"><div class="session-item-title">' + (ex.titulo_ejercicio || ex.titulo_video) + '</div><div class="session-item-meta">' + (ex.duracion || '--') + '</div></div>' +
                    '<button class="session-item-remove" onclick="removeFromSession(' + i + ')">‚úï</button>' +
                '</div>';
            }).join('');
        }

        function removeFromSession(idx) { currentSession.splice(idx, 1); updateSessionUI(); renderExercises(); }
        function clearSession() { currentSession = []; updateSessionUI(); renderExercises(); showToast('üóëÔ∏è Sesi√≥n vaciada', 'success'); }
        function toggleSessionDrawer() {
            document.getElementById('sessionDrawer').classList.toggle('open');
            document.getElementById('drawerBackdrop').classList.toggle('show');
        }

        function saveSession() {
            if (!currentUser) { showAuthModal('login'); return; }
            if (!currentSession.length) { showToast('A√±ade ejercicios primero', 'error'); return; }
            document.getElementById('sessionDate').valueAsDate = new Date();
            document.getElementById('saveOverlay').classList.add('active');
        }

        function closeSaveModal(e) { if (!e || e.target === e.currentTarget) document.getElementById('saveOverlay').classList.remove('active'); }

        async function confirmSaveSession() {
            var name = document.getElementById('sessionName').value.trim();
            if (!name) { showToast('Pon un nombre a la sesi√≥n', 'error'); return; }
            
            var data = {
                usuario_id: currentUser.id,
                nombre: name,
                fecha: document.getElementById('sessionDate').value,
                categoria_edad: document.getElementById('sessionCategoria').value,
                objetivo: document.getElementById('sessionObjetivo').value,
                notas: document.getElementById('sessionNotas').value,
                ejercicios: currentSession.map(function(e) { return e.id; }),
                ejercicios_data: currentSession.map(function(e) { return { id: e.id, titulo: e.titulo_ejercicio || e.titulo_video, thumbnail: e.thumbnail_url, duracion: e.duracion }; }),
                duracion_total: currentSession.reduce(function(t, e) { return t + (e.duracion_segundos || 0); }, 0)
            };
            
            var { error } = await db.from('sesiones').insert(data);
            if (error) { showToast('Error: ' + error.message, 'error'); return; }
            
            showToast('‚úÖ Sesi√≥n guardada', 'success');
            closeSaveModal();
            clearSession();
        }

        function showMySessions() {
            if (!currentUser) { showAuthModal('login'); return; }
            document.getElementById('mySessionsOverlay').classList.add('active');
            loadMySessions();
        }

        function closeMySessionsModal(e) { if (!e || e.target === e.currentTarget) document.getElementById('mySessionsOverlay').classList.remove('active'); }

        async function loadMySessions() {
            var list = document.getElementById('mySessionsList');
            list.innerHTML = '<div class="session-list-loading">Cargando...</div>';
            
            var { data } = await db.from('sesiones').select('*').eq('usuario_id', currentUser.id).order('created_at', { ascending: false });
            
            if (!data || !data.length) {
                list.innerHTML = '<div class="session-list-empty"><div class="session-list-empty-icon">üìã</div><p>No tienes sesiones guardadas</p></div>';
                return;
            }
            
            list.innerHTML = data.map(function(s) {
                var thumbs = (s.ejercicios_data || []).slice(0, 4).map(function(e) { return '<img class="my-session-card-thumb" src="' + (e.thumbnail || '') + '">'; }).join('');
                return '<div class="my-session-card" onclick="viewSession(\'' + s.id + '\')">' +
                    '<div class="my-session-card-header"><div class="my-session-card-name">' + s.nombre + '</div><div class="my-session-card-date">' + (s.fecha || '') + '</div></div>' +
                    '<div class="my-session-card-meta"><span>üìã ' + (s.ejercicios || []).length + ' ejercicios</span><span>‚è±Ô∏è ' + Math.round((s.duracion_total || 0) / 60) + ' min</span></div>' +
                    (s.objetivo ? '<div class="my-session-card-objetivo">"' + s.objetivo + '"</div>' : '') +
                    '<div class="my-session-card-thumbs">' + thumbs + '</div>' +
                '</div>';
            }).join('');
        }

        var currentViewSession = null;
        async function viewSession(id) {
            var { data } = await db.from('sesiones').select('*').eq('id', id).single();
            if (!data) return;
            currentViewSession = data;
            
            document.getElementById('viewSessionTitle').textContent = data.nombre;
            document.getElementById('viewSessionMeta').innerHTML = '<span>üìÖ ' + (data.fecha || '-') + '</span><span>üë∂ ' + (data.categoria_edad || '-') + '</span><span>‚è±Ô∏è ' + Math.round((data.duracion_total || 0) / 60) + ' min</span>';
            document.getElementById('viewSessionObjetivo').textContent = data.objetivo || '';
            
            var exs = (data.ejercicios_data || []).map(function(e, i) {
                return '<div class="view-session-exercise">' +
                    '<div class="view-session-exercise-num">' + (i + 1) + '</div>' +
                    '<img class="view-session-exercise-thumb" src="' + (e.thumbnail || '') + '">' +
                    '<div class="view-session-exercise-info"><div class="view-session-exercise-title">' + e.titulo + '</div><div class="view-session-exercise-meta">' + (e.duracion || '--') + '</div></div>' +
                '</div>';
            }).join('');
            document.getElementById('viewSessionExercises').innerHTML = exs;
            
            closeMySessionsModal();
            document.getElementById('viewSessionOverlay').classList.add('active');
        }

        function closeViewSessionModal(e) { if (!e || e.target === e.currentTarget) document.getElementById('viewSessionOverlay').classList.remove('active'); }

        async function deleteCurrentSession() {
            if (!currentViewSession || !confirm('¬øEliminar esta sesi√≥n?')) return;
            await db.from('sesiones').delete().eq('id', currentViewSession.id);
            closeViewSessionModal();
            showToast('üóëÔ∏è Sesi√≥n eliminada', 'success');
            showMySessions();
        }

        function copySessionLink() {
            navigator.clipboard.writeText(location.origin + '?session=' + currentViewSession.id);
            showToast('üîó Link copiado', 'success');
        }

        // ==================== UPLOAD ====================
        function initUploadTemas() {
            var container = document.getElementById('uploadTemas');
            if (!container) return;
            container.innerHTML = TEMAS_TRABAJADOS.map(function(t) {
                return '<span class="upload-tema-chip" onclick="toggleTema(this)" data-tema="' + t + '">' + t + '</span>';
            }).join('');
        }

        function toggleTema(el) {
            var tema = el.dataset.tema;
            var idx = selectedTemas.indexOf(tema);
            if (idx === -1 && selectedTemas.length < 5) {
                selectedTemas.push(tema);
                el.classList.add('selected');
            } else if (idx !== -1) {
                selectedTemas.splice(idx, 1);
                el.classList.remove('selected');
            }
            validateUpload();
        }

        function showUploadModal() {
            if (!currentUser) { showAuthModal('login'); return; }
            if (currentUser.perfil && currentUser.perfil.plan !== 'coach' && currentUser.perfil.plan !== 'pro') {
                showToast('Necesitas plan Pro o Coach para subir ejercicios', 'error');
                return;
            }
            resetUploadForm();
            document.getElementById('uploadOverlay').classList.add('active');
        }

        function closeUploadModal(e) { if (!e || e.target === e.currentTarget) document.getElementById('uploadOverlay').classList.remove('active'); }

        function resetUploadForm() {
            uploadSource = 'video';
            uploadData = {};
            selectedFamilia = null;
            selectedTemas = [];
            uploadedImageFile = null;
            
            document.getElementById('uploadUrl').value = '';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadExtracted').style.display = 'none';
            document.getElementById('uploadFamiliaSection').style.display = 'none';
            document.getElementById('uploadDescSection').style.display = 'none';
            document.getElementById('uploadTemasSection').style.display = 'none';
            document.getElementById('uploadDetallesSection').style.display = 'none';
            document.getElementById('uploadPizarraSection').style.display = 'none';
            
            document.querySelectorAll('.upload-familia-option').forEach(function(o) { o.classList.remove('selected'); });
            document.querySelectorAll('.upload-tema-chip').forEach(function(c) { c.classList.remove('selected'); });
            document.querySelectorAll('.upload-source-tab').forEach(function(t, i) { t.classList.toggle('active', i === 0); });
            
            document.getElementById('uploadSourceVideo').style.display = 'block';
            document.getElementById('uploadSourceImagen').style.display = 'none';
            document.getElementById('uploadImagePreview').style.display = 'none';
            document.getElementById('uploadImagePlaceholder').style.display = 'flex';
            
            document.getElementById('uploadDescripcion').value = '';
            document.getElementById('uploadDificultad').value = '';
            document.getElementById('uploadEdad').value = '';
            document.getElementById('uploadJugadores').value = '';
            document.getElementById('uploadPorteros').value = '0';
            document.getElementById('uploadDimensiones').value = '';
            
            document.getElementById('btnSubmitExercise').disabled = true;
        }

        function setUploadSource(source) {
            uploadSource = source;
            document.querySelectorAll('.upload-source-tab').forEach(function(t) { t.classList.remove('active'); });
            event.target.classList.add('active');
            
            document.getElementById('uploadSourceVideo').style.display = source === 'video' ? 'block' : 'none';
            document.getElementById('uploadSourceImagen').style.display = source === 'imagen' ? 'block' : 'none';
            
            if (source === 'imagen') {
                document.getElementById('uploadExtracted').style.display = 'none';
                showUploadSteps();
            }
        }

        function handleImageUpload(e) {
            var file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast('Imagen demasiado grande (m√°x 5MB)', 'error'); return; }
            
            uploadedImageFile = file;
            var reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById('uploadImagePreview').src = ev.target.result;
                document.getElementById('uploadImagePreview').style.display = 'block';
                document.getElementById('uploadImagePlaceholder').style.display = 'none';
                showUploadSteps();
            };
            reader.readAsDataURL(file);
        }

        async function extractVideoInfo() {
            var url = document.getElementById('uploadUrl').value.trim();
            if (!url) { showStatus('Introduce una URL', 'error'); return; }
            
            showStatus('üîÑ Extrayendo datos...', 'loading');
            
            // Detect source
            var source = 'youtube';
            var videoId = null;
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                source = 'youtube';
                var m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|shorts\/)([^&\n?#]+)/);
                videoId = m ? m[1] : null;
            } else if (url.includes('twitter.com') || url.includes('x.com')) {
                source = 'twitter';
                var m = url.match(/(?:twitter|x)\.com\/\w+\/status\/(\d+)/);
                videoId = m ? m[1] : null;
            } else if (url.includes('instagram.com')) {
                source = 'instagram';
                var m = url.match(/instagram\.com\/(?:p|reel|reels)\/([A-Za-z0-9_-]+)/);
                videoId = m ? m[1] : null;
            }
            
            if (!videoId) { showStatus('‚ùå URL no v√°lida', 'error'); return; }
            
            uploadData = { source: source, videoId: videoId, videoUrl: url };
            
            if (source === 'youtube') {
                await extractYouTubeData(videoId);
            } else if (source === 'twitter') {
                await extractTwitterData(url);
            } else {
                await extractInstagramData(url);
            }
        }

        async function extractYouTubeData(videoId) {
            uploadData.thumb = 'https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg';
            
            if (!YT_API_KEY) {
                showStatus('‚ö†Ô∏è Sin API Key - datos b√°sicos', 'success');
                showExtractedData();
                return;
            }
            
            try {
                var res = await fetch('https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=' + videoId + '&key=' + YT_API_KEY);
                var data = await res.json();
                
                if (data.error) throw new Error(data.error.message);
                if (!data.items || !data.items.length) throw new Error('Video no encontrado');
                
                var v = data.items[0];
                var dur = parseDuration(v.contentDetails.duration);
                var lang = detectLanguage(v.snippet.defaultAudioLanguage || v.snippet.defaultLanguage);
                
                uploadData.titulo = v.snippet.title;
                uploadData.canal = v.snippet.channelTitle;
                uploadData.descripcion = (v.snippet.description || '').substring(0, 500);
                uploadData.duracion = dur.f;
                uploadData.duracionSeg = dur.s;
                uploadData.vistas = parseInt(v.statistics.viewCount || 0);
                uploadData.likes = parseInt(v.statistics.likeCount || 0);
                uploadData.idioma = lang;
                
                showStatus('‚úÖ Datos extra√≠dos ' + LANG_FLAGS[lang], 'success');
                showExtractedData();
            } catch (err) {
                showStatus('‚ùå ' + err.message, 'error');
            }
        }

        async function extractTwitterData(url) {
            try {
                var res = await fetch('https://publish.twitter.com/oembed?url=' + encodeURIComponent(url) + '&omit_script=true');
                if (!res.ok) throw new Error('No se pudo cargar');
                var data = await res.json();
                
                uploadData.titulo = 'Tweet de ' + data.author_name;
                uploadData.canal = data.author_name;
                uploadData.embedHtml = data.html;
                
                showStatus('‚úÖ Tweet cargado', 'success');
                showExtractedData();
            } catch (err) {
                showStatus('‚ùå ' + err.message, 'error');
            }
        }

        async function extractInstagramData(url) {
            try {
                var res = await fetch('https://api.instagram.com/oembed?url=' + encodeURIComponent(url) + '&omit_script=true');
                if (!res.ok) throw new Error('Post privado o no disponible');
                var data = await res.json();
                
                uploadData.titulo = data.title || 'Post de Instagram';
                uploadData.canal = data.author_name || 'Instagram';
                uploadData.thumb = data.thumbnail_url;
                
                showStatus('‚úÖ Instagram cargado', 'success');
                showExtractedData();
            } catch (err) {
                showStatus('‚ùå ' + err.message, 'error');
                showUploadSteps();
            }
        }

        function parseDuration(iso) {
            var m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!m) return { f: '0:00', s: 0 };
            var h = parseInt(m[1] || 0), min = parseInt(m[2] || 0), sec = parseInt(m[3] || 0);
            return { f: h > 0 ? h + ':' + String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0') : min + ':' + String(sec).padStart(2, '0'), s: h * 3600 + min * 60 + sec };
        }

        function detectLanguage(code) {
            if (!code) return 'es';
            var c = code.substring(0, 2).toLowerCase();
            return ['es', 'en', 'pt', 'it', 'de', 'fr', 'nl'].indexOf(c) !== -1 ? c : 'other';
        }

        function showStatus(msg, type) {
            var el = document.getElementById('uploadStatus');
            el.textContent = msg;
            el.className = 'upload-status ' + type;
        }

        function showExtractedData() {
            document.getElementById('uploadThumb').src = uploadData.thumb || '';
            document.getElementById('uploadPreviewTitle').textContent = uploadData.titulo || 'Video';
            document.getElementById('uploadPreviewChannel').textContent = 'üì∫ ' + (uploadData.canal || '-');
            document.getElementById('uploadPreviewViews').textContent = 'üëÅÔ∏è ' + formatNumber(uploadData.vistas || 0);
            document.getElementById('uploadPreviewLikes').textContent = 'üëç ' + formatNumber(uploadData.likes || 0);
            document.getElementById('uploadPreviewDuration').textContent = '‚è±Ô∏è ' + (uploadData.duracion || '--');
            document.getElementById('uploadPreviewLang').textContent = LANG_FLAGS[uploadData.idioma] || 'üåê';
            document.getElementById('uploadCreditChannel').textContent = uploadData.canal || '-';
            
            document.getElementById('uploadExtracted').style.display = 'block';
            showUploadSteps();
        }

        function showUploadSteps() {
            document.getElementById('uploadFamiliaSection').style.display = 'block';
            document.getElementById('uploadDescSection').style.display = 'block';
            document.getElementById('uploadTemasSection').style.display = 'block';
            document.getElementById('uploadDetallesSection').style.display = 'block';
            document.getElementById('uploadPizarraSection').style.display = 'block';
            validateUpload();
        }

        function selectFamilia(familia) {
            selectedFamilia = familia;
            document.querySelectorAll('.upload-familia-option').forEach(function(o) { o.classList.remove('selected'); });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('familiaExtraProfesional').style.display = familia === 'profesional' ? 'block' : 'none';
            document.getElementById('familiaExtraAnalisis').style.display = familia === 'analisis' ? 'block' : 'none';
            
            validateUpload();
        }

        function validateUpload() {
            var hasSource = (uploadSource === 'video' && uploadData.videoId) || (uploadSource === 'imagen' && uploadedImageFile);
            var hasFamilia = selectedFamilia !== null;
            var hasTemas = selectedTemas.length > 0;
            var hasDificultad = document.getElementById('uploadDificultad').value !== '';
            
            var valid = hasSource && hasFamilia && hasTemas && hasDificultad;
            document.getElementById('btnSubmitExercise').disabled = !valid;
            
            // Update XP
            var xp = 50;
            if (document.getElementById('uploadDescripcion').value.trim()) xp += 10;
            document.getElementById('uploadXpTotal').textContent = '+' + xp + ' XP';
        }

        async function submitExercise() {
            if (!currentUser) return;
            
            var data = {
                source: uploadSource === 'video' ? uploadData.source : 'imagen',
                video_id: uploadData.videoId || null,
                video_url: uploadData.videoUrl || null,
                thumbnail_url: uploadData.thumb || null,
                titulo_video: uploadData.titulo || '',
                titulo_ejercicio: uploadData.titulo || document.getElementById('uploadDescripcion').value.substring(0, 100) || 'Ejercicio',
                canal: uploadData.canal || '',
                descripcion: uploadData.descripcion || '',
                descripcion_usuario: document.getElementById('uploadDescripcion').value,
                duracion: uploadData.duracion || null,
                duracion_segundos: uploadData.duracionSeg || 0,
                vistas: uploadData.vistas || 0,
                likes: uploadData.likes || 0,
                idioma: uploadData.idioma || 'es',
                familia: selectedFamilia,
                categorias: selectedTemas,
                dificultad: parseInt(document.getElementById('uploadDificultad').value),
                edad: document.getElementById('uploadEdad').value,
                jugadores: document.getElementById('uploadJugadores').value,
                num_porteros: parseInt(document.getElementById('uploadPorteros').value) || 0,
                dimensiones: document.getElementById('uploadDimensiones').value,
                entrenador: document.getElementById('uploadEntrenador') ? document.getElementById('uploadEntrenador').value : null,
                equipo: document.getElementById('uploadEquipo') ? document.getElementById('uploadEquipo').value : null,
                sistema: document.getElementById('uploadSistema') ? document.getElementById('uploadSistema').value : null,
                subido_por: currentUser.id,
                estado: 'pendiente',
                aprobado: false
            };
            
            // Upload image if needed
            if (uploadSource === 'imagen' && uploadedImageFile) {
                var fileName = Date.now() + '_' + uploadedImageFile.name;
                var { data: fileData, error: fileError } = await db.storage.from('ejercicios').upload(fileName, uploadedImageFile);
                if (fileError) { showToast('Error subiendo imagen', 'error'); return; }
                data.thumbnail_url = db.storage.from('ejercicios').getPublicUrl(fileName).data.publicUrl;
            }
            
            var { error } = await db.from('ejercicios').insert(data);
            if (error) { showToast('Error: ' + error.message, 'error'); return; }
            
            showToast('‚úÖ Ejercicio enviado para revisi√≥n', 'success');
            closeUploadModal();
        }

        // ==================== HELPERS ====================
        function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        function showToast(msg, type) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + type + ' show';
            setTimeout(function() { t.className = 'toast'; }, 3000);
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) document.getElementById('userDropdown')?.classList.remove('show');
            if (!e.target.closest('.notif-bell')) document.getElementById('notifDropdown')?.classList.remove('show');
        });

        // Add change listeners for validation
        document.getElementById('uploadDificultad')?.addEventListener('change', validateUpload);
        document.getElementById('uploadDescripcion')?.addEventListener('input', validateUpload);
    </script>
</body>
</html>
